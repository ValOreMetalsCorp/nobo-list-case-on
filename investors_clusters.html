<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Investor Map by Area – Ontario (Demo)</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      #legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 10px 14px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        font-size: 14px;
        line-height: 1.5;
        z-index: 3;
      }

      /* Header fixo com título e botão */
      #header {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 14px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        font-family: Arial, sans-serif;
        z-index: 20;
      }

      #header h2 {
        margin: 0;
        font-size: 15px;
        color: #222;
        white-space: nowrap;
      }

      #header button {
        background: #3b5998;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
      }

      #header button:hover {
        background: #2d4373;
      }

      /* Caixa de filtro */
      #filter-box {
        position: absolute;
        top: 70px;
        left: 10px;
        background: white;
        padding: 12px 16px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        font-size: 14px;
        z-index: 10;
        line-height: 1.6;
      }

      #filter-box b {
        display: block;
        margin-bottom: 4px;
        color: #17193b;
      }

      #filter-box label {
        display: block;
        margin: 3px 0;
      }

      /* Contador */
      #counter {
        margin-top: 8px;
        font-weight: bold;
        text-align: center;
        color: #17193b;
      }
    </style>
  </head>

  <body>
    <!-- Cabeçalho -->
    <div id="header">
      <h2>Investor Map by Area – Ontario</h2>
      <button onclick="window.location.href='index.html'">Back to Index</button>
    </div>

    <!-- Filtros de Área -->
    <div id="filter-box">
      <b>Show Areas:</b>
      <label><input type="checkbox" id="areaToronto" checked> Toronto 40 km</label>
      <label><input type="checkbox" id="areaCollingwood" checked> Collingwood 40 km</label>
      <label><input type="checkbox" id="areaOutside" checked> Outside</label>
      <div id="counter">Visible Investors: 0</div>
    </div>

    <div id="map"></div>
    <div id="legend"></div>

    <script>
      async function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 8.3,
          center: { lat: 44.2, lng: -79.9 },
          mapTypeId: "roadmap"
        });

        // 🔹 Carregar dados dos investidores
        const invResponse = await fetch("investors_map.json");
        const investors = await invResponse.json();

        // 🔹 Ícones por área (com tamanho reduzido)
        const areaIcons = {
          "Toronto 40 km": {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            scaledSize: new google.maps.Size(18, 18)
          },
          "Collingwood 40 km": {
            url: "http://maps.google.com/mapfiles/ms/icons/purple-dot.png",
            scaledSize: new google.maps.Size(18, 18)
          },
          "Outside": {
            url: "http://maps.google.com/mapfiles/ms/icons/gray-dot.png",
            scaledSize: new google.maps.Size(18, 18)
          }
        };

        // 🔹 Agrupar marcadores por área
        const markersByArea = { "Toronto 40 km": [], "Collingwood 40 km": [], "Outside": [] };

        investors.forEach(inv => {
          if (inv.lat && inv.lon) {
            const latOffset = (Math.random() - 0.5) * 0.0006;
            const lonOffset = (Math.random() - 0.5) * 0.0006;
            const area = inv.area_classification || "Outside";

            const icon = areaIcons[area] || areaIcons["Outside"];

            const marker = new google.maps.Marker({
              position: { lat: inv.lat + latOffset, lng: inv.lon + lonOffset },
              map,
              title: `${inv.name} (${inv.city})`,
              icon: icon
            });

            const info = new google.maps.InfoWindow({
              content: `
                <div style="font-size:14px; line-height:1.4;">
                  <b>${inv.name}</b><br>
                  City: ${inv.city}<br>
                  Province: ${inv.province}<br>
                  Shares: ${Number(inv.shares).toLocaleString()}<br>
                  Area: ${area}<br>
                  Cluster: ${inv.cluster}<br>
                </div>`
            });

            marker.addListener("click", () => info.open(map, marker));

            if (markersByArea[area]) {
              markersByArea[area].push(marker);
            } else {
              markersByArea["Outside"].push(marker);
            }
          }
        });

        // 🔹 Função de atualização do contador
        function updateCounter() {
          let visibleCount = 0;
          for (const area in markersByArea) {
            markersByArea[area].forEach(marker => {
              if (marker.getVisible()) visibleCount++;
            });
          }
          document.getElementById("counter").textContent = `Visible Investors: ${visibleCount}`;
        }

        // 🔹 Checkbox de filtro
        const checkboxes = {
          "Toronto 40 km": document.getElementById("areaToronto"),
          "Collingwood 40 km": document.getElementById("areaCollingwood"),
          "Outside": document.getElementById("areaOutside")
        };

        for (const [area, checkbox] of Object.entries(checkboxes)) {
          checkbox.addEventListener("change", () => {
            const visible = checkbox.checked;
            markersByArea[area].forEach(marker => marker.setVisible(visible));
            updateCounter();
          });
        }

        updateCounter();

        // 🔹 Legenda simples
        const legend = document.getElementById("legend");
        legend.innerHTML = `
          <b>Map Legend</b><br>
          <div style="display:flex;align-items:center;margin-bottom:5px;">
            <div style="width:14px;height:14px;background:#1E90FF;margin-right:6px;border-radius:50%;"></div>
            Toronto 40 km investors
          </div>
          <div style="display:flex;align-items:center;margin-bottom:5px;">
            <div style="width:14px;height:14px;background:#8A2BE2;margin-right:6px;border-radius:50%;"></div>
            Collingwood 40 km investors
          </div>
          <div style="display:flex;align-items:center;margin-bottom:5px;">
            <div style="width:14px;height:14px;background:#808080;margin-right:6px;border-radius:50%;"></div>
            Outside investors
          </div>
          <hr style="margin:6px 0;">
          <div>Data source: investors_map.json</div>
        `;
        map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);
      }
    </script>

    <!-- 🔑 Google Maps API -->
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCpc7QvLyEbejJL1bwaV--hsQHS1gFFoWg&callback=initMap">
    </script>
  </body>
</html>
