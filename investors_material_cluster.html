<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ValOre – NOBO Investors | Materials Delivery (Ontario)</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #map {
      position: absolute;
      inset: 0;
      z-index: 0;
    }

    /* HEADER */
    #header {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.95);
      padding: 8px 14px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 40;
      max-width: 90%;
    }

    #header h2 {
      margin: 0;
      font-size: 15px;
      color: #222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #back-btn {
      text-decoration: none;
      background: #3b5998;
      color: white;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: bold;
    }

    #back-btn:hover { background: #2d4373; }

    /* FILTER BOX */
    #filter-box {
      position: absolute;
      top: 70px;
      left: 10px;
      width: 260px;
      background: white;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 30;
      max-height: calc(100vh - 150px);
      overflow-y: auto;
      font-size: 13px;
    }

    #filter-box b {
      display: block;
      margin: 10px 0 6px;
      font-weight: bold;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
      color: #17193b;
    }

    .checkbox-list {
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 6px;
      background: #fcfcfc;
      max-height: 160px;
      overflow-y: auto;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      cursor: pointer;
    }

    .checkbox-item:hover {
      background: #f0f0f0;
    }

    #counter {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 2px solid #eee;
      text-align: center;
      font-weight: bold;
      color: #17193b;
    }

    /* LEGEND */
    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-size: 13px;
      z-index: 20;
    }

    #legend img {
      width: 18px;
      height: 18px;
      vertical-align: middle;
      margin-right: 6px;
    }
  </style>
</head>

<body>

<div id="header">
  <a id="back-btn" href="index.html">← Back</a>
  <h2>ValOre – Materials Delivery Clusters (Ontario)</h2>
</div>

<div id="filter-box">

  <b>Material Delivery Cluster</b>
  <div class="checkbox-list">
    <label class="checkbox-item"><input type="checkbox" name="cluster" value="top priority" checked> Top Priority – Authorized (A)</label>
    <label class="checkbox-item"><input type="checkbox" name="cluster" value="high potential" checked> High Potential – Authorized (A)</label>
    <label class="checkbox-item"><input type="checkbox" name="cluster" value="medium potential" checked> Medium Potential – Authorized (A)</label>
    <label class="checkbox-item"><input type="checkbox" name="cluster" value="low potential" checked> Low Potential – Authorized (A)</label>
    <label class="checkbox-item"><input type="checkbox" name="cluster" value="restricted" checked> Restricted – Selective Materials (S)</label>
    <label class="checkbox-item"><input type="checkbox" name="cluster" value="declined" checked> Declined – No Materials (D)</label>
  </div>

  <b>Distance from Toronto City Hall</b>
  <div class="checkbox-list">
    <label class="checkbox-item"><input type="checkbox" name="dist" value="local" checked> ≤ 10 km</label>
    <label class="checkbox-item"><input type="checkbox" name="dist" value="nearby" checked> 10 – 40 km</label>
    <label class="checkbox-item"><input type="checkbox" name="dist" value="medium" checked> 40 – 100 km</label>
    <label class="checkbox-item"><input type="checkbox" name="dist" value="regional" checked> 100 – 300 km</label>
    <label class="checkbox-item"><input type="checkbox" name="dist" value="distant" checked> > 300 km</label>
  </div>

  <div id="counter">Loading…</div>
</div>

<div id="map"></div>
<div id="legend"></div>

<script>
/* =========================
   UTILS
========================= */
function normalize(str) {
  return String(str || "").toLowerCase().replace(/[^a-z0-9]/g, "");
}

function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* =========================
   CONFIG
========================= */
const TORONTO = { lat: 43.6532, lng: -79.3832 };

const MATERIAL_ICONS_RAW = {
  "top priority": "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
  "high potential": "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
  "medium potential": "https://maps.google.com/mapfiles/ms/icons/purple-dot.png",
  "low potential": "https://maps.google.com/mapfiles/ms/icons/pink-dot.png",
  "restricted": "https://maps.google.com/mapfiles/ms/icons/orange-dot.png",
  "declined": "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
};

let map;
let markers = [];
let allInvestors = [];

/* =========================
   MAP
========================= */
async function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 8.2,
    center: TORONTO,
    mapTypeControl: false,
    streetViewControl: false
  });

  setupLegend();

  const res = await fetch("investors_nobo_minimal.json");
  allInvestors = await res.json();
  renderMarkers();
}

function renderMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];

  const clusters = [...document.querySelectorAll("input[name='cluster']:checked")].map(c => c.value);
  const dists = [...document.querySelectorAll("input[name='dist']:checked")].map(d => d.value);

  let count = 0;

  allInvestors.forEach(inv => {
    const lat = Number(inv.lat), lon = Number(inv.lon);
    if (!lat || !lon) return;

    const raw = normalize(inv["Final Investor Cluster Materials"]);
    if (!clusters.some(c => raw.includes(normalize(c)))) return;

    const km = haversineDistance(TORONTO.lat, TORONTO.lng, lat, lon);
    if (
      (km <= 10 && !dists.includes("local")) ||
      (km > 10 && km <= 40 && !dists.includes("nearby")) ||
      (km > 40 && km <= 100 && !dists.includes("medium")) ||
      (km > 100 && km <= 300 && !dists.includes("regional")) ||
      (km > 300 && !dists.includes("distant"))
    ) return;

    const iconKey = Object.keys(MATERIAL_ICONS_RAW).find(k => raw.includes(k));
    if (!iconKey) return;

    markers.push(new google.maps.Marker({
      map,
      position: { lat, lng: lon },
      icon: MATERIAL_ICONS_RAW[iconKey]
    }));
    count++;
  });

  document.getElementById("counter").innerText = `Shown: ${count} Investors`;
}

function setupLegend() {
  document.getElementById("legend").innerHTML = `
    <b>Material Delivery Status</b><br>
    <img src="${MATERIAL_ICONS_RAW["top priority"]}"> Top Priority – Authorized (A)<br>
    <img src="${MATERIAL_ICONS_RAW["high potential"]}"> High Potential – Authorized (A)<br>
    <img src="${MATERIAL_ICONS_RAW["medium potential"]}"> Medium Potential – Authorized (A)<br>
    <img src="${MATERIAL_ICONS_RAW["low potential"]}"> Low Potential – Authorized (A)<br>
    <img src="${MATERIAL_ICONS_RAW["restricted"]}"> Restricted – Selective (S)<br>
    <img src="${MATERIAL_ICONS_RAW["declined"]}"> Declined – No Materials (D)
  `;
}

document.addEventListener("change", renderMarkers);
window.initMap = initMap;
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDy3FD3k3MpOnMGZvfo7IOeq9SKESf35fg&callback=initMap">
</script>

</body>
</html>
