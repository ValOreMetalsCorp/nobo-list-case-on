<script>
  async function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 8.3,
      center: { lat: 44.2, lng: -79.9 },
      mapTypeId: "roadmap"
    });

    // 🔹 Carregar o JSON
    const response = await fetch("ontario_socioeconomic_clusters_geo.json");
    const data = await response.json();

    // 🎯 Filtrar somente Cluster 1
    const filtered = data.filter(d => d.socioeconomic_cluster === 1);

    // 🔵 Criar círculos de 15 km, mais transparentes
    filtered.forEach(d => {
      const lat = parseFloat(d.lat);
      const lon = parseFloat(d.lon);
      const fsa = d.fsa;

      if (!isNaN(lat) && !isNaN(lon)) {
        const circle = new google.maps.Circle({
          strokeOpacity: 0,
          fillColor: "#708090",
          fillOpacity: 0.25,
          map,
          center: { lat, lng: lon },
          radius: 15000
        });

        const info = new google.maps.InfoWindow({
          content: `
            <b>FSA:</b> ${fsa}<br>
            <b>Cluster:</b> 1 – High-Income / High-Investment<br>
            <b>Coverage radius:</b> ≈15 km
          `
        });

        circle.addListener("click", () => info.open(map));
      }
    });

    // 🧭 Legenda principal
    const legend = document.getElementById("legend");
    legend.innerHTML = `
      <b>Map Legend</b><br>

      <!-- Áreas prioritárias -->
      <div style="display:flex;align-items:center;margin-bottom:4px;">
        <div style="width:14px;height:14px;border-radius:50%;background:#708090;margin-right:6px;opacity:0.25;"></div>
        ≈15 km coverage areas – High-Income & Investor Concentration
      </div>

      <!-- Círculos das cidades -->
      <div style="display:flex;align-items:center;margin-bottom:4px;">
        <div style="width:14px;height:14px;border:1px solid #000;border-radius:50%;margin-right:6px;background:none;"></div>
        40 km radius – Toronto area
      </div>
      <div style="display:flex;align-items:center;margin-bottom:4px;">
        <div style="width:14px;height:14px;border:1px solid #000;border-radius:50%;margin-right:6px;background:none;"></div>
        40 km radius – Collingwood area
      </div>

      <hr style="margin:6px 0;">

      <!-- Corredor e rodovias -->
      <div style="display:flex;align-items:center;margin-bottom:4px;">
        <span style="color:#FF0000;margin-right:6px;">&#8212;&#8212;&#8212;</span>
        Corridor (≈15 km buffer around Highways 400 & 10)
      </div>
      <div style="display:flex;align-items:center;">
        <span style="color:#000;margin-right:6px;">&#8212;&#8212;&#8212;</span>
        Highways 400 & 10 (Dashed)
      </div>
    `;
    map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);

    // 📍 Reference points
    const collingwood = { lat: 44.5008, lng: -80.2144 };
    const toronto = { lat: 43.6532, lng: -79.3832 };

    // 🏛️ City markers
    new google.maps.Marker({
      position: collingwood,
      map,
      icon: {
        url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png",
        scaledSize: new google.maps.Size(36, 36)
      },
      title: "Collingwood City Hall"
    });

    new google.maps.Marker({
      position: toronto,
      map,
      icon: {
        url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png",
        scaledSize: new google.maps.Size(36, 36)
      },
      title: "Toronto City Hall"
    });

    // 🔸 City circles (40 km)
    new google.maps.Circle({
      strokeColor: "#000000",
      strokeOpacity: 0.7,
      strokeWeight: 1,
      fillColor: "#000000",
      fillOpacity: 0.00,
      map,
      center: toronto,
      radius: 40000
    });

    new google.maps.Circle({
      strokeColor: "#000000",
      strokeOpacity: 0.7,
      strokeWeight: 1,
      fillColor: "#000000",
      fillOpacity: 0.00,
      map,
      center: collingwood,
      radius: 40000
    });

    // 🛣️ Highways (dashed black)
    const highway400 = [
      collingwood,
      { lat: 44.39, lng: -79.69 },
      { lat: 43.9, lng: -79.51 },
      toronto
    ];
    const highway10 = [
      collingwood,
      { lat: 44.3, lng: -80.0 },
      { lat: 43.9, lng: -79.9 },
      toronto
    ];

    [highway400, highway10].forEach(path => {
      new google.maps.Polyline({
        path,
        geodesic: true,
        strokeColor: "#000000",
        strokeOpacity: 0.8,
        strokeWeight: 1,
        icons: [
          {
            icon: { path: "M 0,-1 0,1", strokeOpacity: 1, scale: 4 },
            offset: "0",
            repeat: "20px"
          }
        ],
        map
      });
    });

    // 🔺 Corridor polygon (15 km buffer)
    const corridor = [
      { lat: 44.62, lng: -80.35 },
      { lat: 44.48, lng: -79.58 },
      { lat: 44.05, lng: -79.3 },
      { lat: 43.6, lng: -79.35 },
      { lat: 43.55, lng: -79.85 },
      { lat: 43.85, lng: -80.15 },
      { lat: 44.35, lng: -80.25 },
      { lat: 44.62, lng: -80.35 }
    ];

    new google.maps.Polygon({
      paths: corridor,
      strokeColor: "#FF0000",
      strokeOpacity: 0.8,
      strokeWeight: 1,
      fillOpacity: 0,
      map
    });
  }
</script>

    <!-- 🔑 Sua chave do Google Maps -->
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCpc7QvLyEbejJL1bwaV--hsQHS1gFFoWg&callback=initMap">
    </script>
  </body>
</html>